# Библиотека BARSXML

Библиотека предназначена для формирование _XML_ пакетов для МИС ТФОМС.
Протоколы информационного обмена, порядок, форматы обмена, регламентируются
нормативными документами [ФФОМС](https://ffoms.gov.ru/documents/interaction/)
и ТФОМС (территориальными ФОМС).

В актуальной версии библиотеки, единственной МИС ТФОМС для которой реализована
возможность работы с файлами обмена является МИС ТФОМС Приморского края РФ.

Построения более универсальной библиотеки, требует участия в данном проекте МО других
регионов.

Исходный код библиотеки находится в <a href="https://github.com/SLikhachev/barsxml" target=_blank>открытом доступе</a>. Приложение предоставляется на условиях лицензии __"BSD-3"__.

## Установка и тестирование

Код библиотеки написан на языке программирования Python3, рекомендуется использовать
интерпретатор Python версии не ниже 3.6.8.

Рекомендуется устанавливать библиотеку в виртуальном окружении.

### Зависимости

Для корректной работы кода требуется установленная библиотека __psycopg2-binary==2.9.2__.
Для тестирования кода дополнительно требуются:

- requests==2.27.1
- pytest==6.2.5
- pytest-env

### Установка в виртуальном окружении

Предполагается, что ИТ администратор МО в общих чертах знаком с ЯП Python3,
инструментами работы и средой исполнения интерпретатора. Далее приведены команды
для ОС Linux.

Создание виртуального окружения:

    [user ]$ cd ~/
    [user ]$ python3 -m venv venv
    [user ]$ cd venv
    [venv ]$ source bin/activate

Клонирование репо библиотеки:

    (venv) [venv ]$ git clone git@github.com:SLikhachev/barsxml.git
    (venv) [venv ]$ cd barsxml

Установка зависимостей и самой библиотеки:

    (venv) [barsxml ]$ python -m pip install -r requirements.txt

### Тестирование

Для тестирования необходимо выполнение условий:

1. в сети развернут сервер СУБД Postgresql;
2. в кластере сервера развернута [рабочая БД](./workdb.md);
3. в рабочей БД заполнены тестовые таблицы [карт и талонов](../user/clinic/clinic.md) за некоторый тестовый период.

Скопируйте файл pytest_demo.ini:

    (venv) [barsxml ]$ cp pytest_demo.ini pytest.ini

Отредактируйте следующие переменные в файле `pytest.ini`:

    DB_HOST= 127.0.0.1
    DB_NAME= dbname
    DB_SCHEMA= dbschema
    DB_USER= dbuser
    DB_PASSWORD= dbpass
    TEST_YEAR=2021
    TEST_MONTH=11

указав актуальные значения для указанных переменных окружения.

Запустите тест:

    (venv) [barsxml ]$ pytest

В настоящее время в библиотеке имеется только 1 тест на формирование 1 типа пакета
(амбулаторный прием).

## Структура каталогов

Основной код находится в каталоге `src/barsxml` корня проекта.

Основной интерес представляет содержимое каталогов и файлов:

- `config/postgresxml.py` - некоторые конфигурационные параметры для Postgresql
- `sql/sqlpostgres.py` - реализация класса sql провайдера для Postgresql
- `xmlstruct/*.py` - xml структуры формируемых файлов пакета

## API Формирование реестра

Для формирования реестра вызывающий код должен создать экземпляр класса
__BarsXml__.

> class __BarsXml__ (*config*, *pack_type*, *mo_code*, *month*, *pack_num*)

Параметры:

    config: object( Объект конфигурации с набором атрибутов:
        SQL_PROVIDER: str - для импорта нужного класса sql провайдера
        sql_srv: dict - для выполнения соединения с БД
        year: str(4) - год отчетности, для выбора корректной таблицы талонов
        base_xml_dir: str - абсолютный путь к каталогу сформированных пакетов
    )
    pack_type: str(3) - ключ в словаре TYPES ('xml')
    mo_code: str(6) код МО, например: '250799'
    month: str(2) - отчетный месяц: '01'-'12'
    pack_num: int - последовательный номер пакета, например 2

Пример объекта конфигурации можно найти в файле `tests/xml_pg_config.py`.

В настоящее время поддерживается только `pack_type='xml'`.

Экземпляр класса имеет единственный метод:

> __make_xml__ (*mark_sent*, *get_fresh*, *check=False*)

Параметры:

    mark_sent (bool) - если True устанавливает тип талонов включенных в реестр
        как отправлен (talon_type=2), иначе игнорируется

    get_fresh (bool) - если True не включаются в реестр уже отправленные талоны
        с типом 2, иначе в реестр включаются все талоны

    check (bool) - если True проводится проверка талонов на корректность,
        реестр не формируется

Возвращает кортеж:

    hm_records, pm_records, zip_file_path, errors_find

где:

- *hm_records* - количество узлов `ZAP` в xml файлах HM и PM
- *pm_records* - количество узлов `PERS` в xml файле LM
- *zip_file_path* - абсолютный путь к сформированному пакету
- *errors_find* - количество найденных не корректных талонов, не попавших в пакет
