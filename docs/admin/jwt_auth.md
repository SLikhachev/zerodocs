# Аутентификация сервисов по JWT

## 1. Общие положения

Сервисы **pg_rest** и **task_rest** аутентифицируют запрос к БД с помощью **JWT**.
JWT заявление содержит поля:

    {
        "role":"webuser",
        "user":"user",
        "exp":exipred
    }

В поле **role** находится имя роли БД Postgresql которое будет установлено как

    SET LOCAL ROLE webuser;

сразу после соедениния с БД (то есть, роль локальной сессии, со всеми правами и
ограничениями для этой роли).

Само соединение приозводится библиотекой psycopg2 по DSN указанному в параметрах
вызова, для python прложения, или в конфигурационном файле Postgrest сервера.

> Например: <postgres://dbauth:mysecret@localhost:5432/ourbase?ssl=disable>

## 2. Доступ к таблицам и записям БД

БД имеeт владельца **dbowner**.

Для некоторых таблиц установлены правила RLS, таким образом, что каждая такая таблица имеет дополнительное поле (колонку) **cuser**, которе устанавливает права на эту запись.

При добавлении записи в таблицу, это поле должно быть указано обязательно, если для такой
таблицы установлены правила RLS (по дефолту в данное поле записывается значение
переменной **current_user** СУБД).

Измененить или удалить записи с RLS может только владелец записи.

При чтении из таблицы, при определенных условиях, будут выбраны только те записи,
которые имеют, одинаковое значение поля **cuser**.

## 3. Сервис pg_rest

Для  **pg_rest** установлены три типа ролей:

- anonymous
- authenticator (auth)
- user

Роль **auth** не должна наследваться **(NOINHERIT)** другими ролями, и должна иметь
ограниченный доступ к базе. Эта роль предназначена, для соединения с базой, с последующей установкой текущей роли сессии.

Администратор БД должен предоставить роли **auth** право наследовать роли **anonymous**
и **user**

    GRANT user TO authenticator;
    GRANT anonymous TO authenticator;

В этом случае после соединения с БД можно будет установить текущую роль сессии:

    SET LOCAL ROLE user;

Конфигурация сервера может содержать или не содержать параметр **jwt-secret**.

Если **jwt-secret** не установлен и клиент не передает северу **HTTP** заголовок
**Authorization Bearer JWT**, в этом случае *pg_rest* переключится на локальную
анонимную роль, которая должна быть точно указана в конфигурационном файле сервера.

Если **jwt-secret** не установлен и клиент передает северу **HTTP** заголовок
**Authorization Bearer JWT**, в этом случае возникает ошибка.

Если **jwt-secret** установлен и клиент не передает северу **HTTP** заголовок
**Authorization Bearer JWT**, в этом случае возникает ошибка.

Если **jwt-secret** установлен и клиент передает северу **HTTP** заголовок
**Authorization Bearer JWT** в которм заявлено поле **role**, в этом случае *pg_rest*
переключится на локальную роль заявленную в этом поле, если такого поля в заявлении нет,
*pg_rest* переключится на локальную анонимную роль, указанную в конфигурационном
файле сервера.

Разрешения для анонимной роли, должны быть установлены администраторм БД, таким
образом, чтобы предовратить доступ этой роли к определенному содержимому БД.

### 3.1 pg_rest сервер для БД развернутой в частой локальной сети или частном облаке

В случае чстной БД доступной только для конкретной организации, используются
следующий настройки БД и pg_rest сервера.

Для БД создаем пользователей **dbauth, dbowner, dbuser** с правми
(первоначально как postgres):

    CREATE ROLE dbauth NOINHERIT LOGIN PASSWORD 'mysecret';
    CREATE ROLE dbowner NOLOGIN CREATEDB;
    CREATE ROLE dbuser NOLOGIN;
    GRANT dbowner TO dbauth;
    GRANT dbuser TO dbauth;

В данной конфигурации роль ононимного ползователя выполняет **dbuser**

Коннектимся к БД как **dbauth**, устанавливаем локального пользователя **dbowner**,
создаем БД, выплняем инициализацию базы и даем права анонимному пользователю
право на чтение всех таблиц:

    SET LOCAL ROLE dbowner;
    CREATE DATABASE ourbase;
    -- restore dump of the empty db or if have template use it ---
    GRANT ALL ON ALL TABLES TO dbuser;
    -- + право чтения последовательность и предствалений

Таким образом, роль для коннекта к СУБД **dbauth**, владелец базы со всеми правами
**dbowner**, и анонимный пользователь со всеми правами на БД **dbuser**.

В данной конфигурации мы не используем RLS. Владелец имеет все права, и для корректной
работы приложения **pg_rest** в таком режиме необходимо сконфигурировать сервер PostgRest
следующим образом:

    db-uri="postgres://dbanon:mysecret@my_host:my_port/ourbase"
    server-port=9090
    db-schema="public"
    db-anon-role="dbuser"
    jwt-secret="super_sectret_string"

При этом каждый запрос должен сдуржать HTTP заголовок:

    Authorization Bearer JWT

где JWT собственно подписааный токен содержащий заявление:

    {
        "role":"dbuser",
        "user":"cuser",
        "exp":exipred
    }

#### 3.1.1. Контроль поля *cuser*

При такой организации доступа к непубличной базе каждый запрос на добавление/изменение
записей может (и возможно должен) содержать явное значение для поля **cuser**. При отсутвии
значеня, как выше указано, в такое поле будет установлено значение переменной **current_user**
(то есть фактически имя роли для локальной сессии)

### 3.2 Простой дефолтный способ конфигурации для pg_rest

В самом простом случае, что бы не усложнять конфигурацию сервера, можно не указывать
параметр

    jwt-secret="super_sectret_string"

в кофигурации севера. В этом случае, после соеденния с сервером будет установлена локальная
роль **db-anon-role** конфигурации. Если определить этот параметр как

    db-anon-role="dbowner"

сразу после соедениня с сервером, локальной ролью будет роль **dbowner** со всеми правами
в отношении БД. Никакие дальнейшие настройки не требуются.

В этом случае все замечания в отношении контроля поля **cuser** отстаются такими же как
указано в п. 3.1.1.  (то есть, вы можете либо явно задавать значение этого поля, либо оставить его
дефолными, в данном примере значение будет **dbowner**)

### 3.3 pg_rest сервер для БД развернутой в публичном облаке

В публичном облаке мы не размещаем конфиденциальной информации. Вся информация в БД
является тестовой, и предназначено талько для демонстрации работы приложения.

Поскольку в этом случае, доступ к БД имеет множество пользователей приложения, никак между
собой не связанных, каждый запрос к серверу *pg_rest* будет содержать JWT с обязательными
заявлениями **role** и **user**.

    {
        "role":"webuser",
        "user": ( web site logged in user )
    }

Публичная анонимная роль: **webanon**, роль локальной сессии: **webuser**. Роли **auth** и
**dbowner**, вспомогательные.
Роли **webanon** не предоставлено никаких прав, поэтому, каждый зпрос дожен имет подписанный
токен.

Роли **webuser** предоставлены права:

    GRANT SELECT ON ALL TABLES IN SCHEMA public TO webuser;
    GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO webuser;
    GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO webuser;
    GRANT ALL ON TABLE some_cuser_controlled_tables TO webuser;

Для некоторых таблиц (имеющих колонку **cuser**) мы обязательно устанавливаем правила RLS.

    ALTER TABLE public.some_table ENABLE ROW LEVEL SECURITY;
    CREATE POLICY some_table_policy ON public.some_table
        USING (current_setting('request.jwt.claim.user', false) = cuser);

Эти установки действительны для Postgresql version < 14.

Указанная переменная **'request.jwt.claim.user'** автоматически устанавливается сервером
**pg_rest**.

Для публичного облака конфигурация сервера должна быть такой:

    # postgrest.conf

    # The standard connection URI format, documented at
    # https://www.postgresql.org/docs/current/static/libpq-connect.html#AEN45347
    db-uri = "postgres://dbatuh:my_secret@my_host:5432/demobase"
    server-port = a_port

    #-----------------------------------------------------------
    # The name of which database schema to expose to REST clients
    db-schema = "public"

    #-----------------------------------------------------------
    # The database role to use when no client authentication is provided.
    # Can (and probably should) differ from user in db-uri
    db-anon-role = "webanon"
    log-level="info"
    jwt-secret="my_hard_top_secret"

    # this server will be used with Auth bearer and RLS
