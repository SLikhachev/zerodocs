# task_rest - Сервер Taskrest

Сервер Taskrest является простым web приложением выполненным на языке
программирования Python3 с помощью фреймворка <a href="https://palletsprojects.com/p/flask/" target=_blank>__Flask__</a>, и предоставляет web API для:

- формирования XML пакетов для МИС ТФОМС;
- импорта протоколов ошибок, обнаруженных МИС ТФОМС, в сформированных пакетах;
- импорта счетов, сформированных МИС ТФОМС, по результатам приема пакетов;
- экспорта счетов в файлы XLSX;
- переноса случаев, не принятых МИС ТФОМС по результатам МЭК, на другой отчетный месяц;
- выгрузки случаев не принятых МИС ТФОМС по МЭК в файл в формате CSV.

 Исходный код приложения доступен <a href="https://github.com/SLikhachev/task_rest" target=_blank>по адресу</a>. Приложение предоставляется на условиях лицензии __"BSD-3"__.

## Установка и тестирование

Рекомендуется использовать интерпретатор `Python` версии не ниже `3.8.1`. Рекомендуется устанавливать приложение в виртуальном окружении.

### Зависимости

Для корректной работы и тестирования кода требуются пакеты:

- werkzeug==2.0.2
- Flask==2.0.2
- Flask-RESTful==0.3.9
- openpyxl==3.0.9
- psycopg2-binary==2.9.2
- requests==2.27.1
- pytest==6.2.5
- pytest-env
- gunicorn==20.1.0
- pyjwt==2.4.0

Формирование XML пакетов выполняется с помощью библиотеки [barsxml](./barsxml.md),
поэтому библиотека должныв быть установлена в виртуальном окружении.

### Установка в виртуальном окружении

Предполагается, что ИТ администратор МО в ощих чертах знаком с ЯП Python3,
инструментами работы и средой исполнения интерпрататора. Далее приведены комнанды
для ОС Linux.

Создание виртуального окружения:

    [user ]$ cd ~/
    [user ]$ python3 -m venv venv
    [user ]$ cd venv
    [user ]$ source bin/activate

Клонирование репо библиотеки:

    (venv) [venv ]$ git clone git@github.com:SLikhachev/task_rest.git
    (venv) [venv ]$ cd task_rest

Установка зависимостей:

    (venv) [task_rest ]$ python -m pip install -r requirements.txt

### Тестирование

Для тестирования необходимо выполнение условий:

1. в сети развернут сервер СУБД Postresql;
2. в кластере сервера развернута [рабочая БД](./workdb.md);
3. в рабочей БД заполнены тестовые таблицы [карт и талонов](../user/clinic/clinic.md) за некоторый тестовый период.

Отредакитруйте следующие переменные в файле `pytest.ini`:

    DB_HOST= 127.0.0.1
    DB_NAME= dbname
    DB_SCHEMA= dbschema
    DB_USER= dbuser
    DB_PASSWORD= dbpass
    TEST_YEAR=2021
    TEST_MONTH=11
    MO_CODE=250999
    PACK= xml
    BARS_ERR_FILE=FHT25M250999_22039992.xml
    BARS_INVOICE_FILE=HM250999S25011_22039994.zip

указав актуальные значения для указанных переменных окружения.

Тестовые файлы _ошибок МИС ТФОМС_ и _счета_ с именами указанными в перемеменных:

    BARS_ERR_FILE=FHT25M250999_22039992.xml
    BARS_INVOICE_FILE=HM250999S25011_22039994.zip

соответвенно, должны находится в каталоге `tests/data` корня проекта приложения.
Имена должны соответветвовать шаблонам для указанных файлов.

Запустите тесты:

    (venv) [task_rest ]$ pytest

### Конфигурация приложения

Конфигурация приложения выполняется в двух файлах:

1. poly/config.py;
2. instance/config_instance.py.

#### Общий файл `poly/config.py`

В этом файле находятся несколько общих объектов конфигурации приложения, файл
расположен в каталоге `poly` корня приложения.

#### Файл конфигурации экземпляра приложения

Этот файл должен быть расположен в каталоге `instance` корня приложения. Пример
файла конфигурации экземпляра `config_instance.py`расположен в каталоге `poly` вместе
с общим конфигурационным файлом `config.py`.

Для корректной кофигурации экземпляра, создайте каталог `instance` в корне приложения,
скопируйте файл `config_instance.py`, в файл `config_prod.py` и отредактируйте параметры конфигурации.

    (venv) [task_rest ]$ mkdir instance
    (venv) [task_rest ]$ cp poly/config_instance.py instance/config_prod.py

#### Создание экземпляра приложения

Экземпляр приложения создается в файле `__init__.py`, который расположен в корне
каталога `poly`. Конфигурационные файлы импортируются в приложение при его создании,
обратите внимание на строки кода файла `__init__.py`, котрые устанавливают
переменную `instance_path`, а так же на имена файлов импорта:

```python
# import configs from instance
if env == 'production':
    app.config.from_pyfile('config_prod.py')
else:
    app.config.from_pyfile('config_dev.py')
```

### WEB API приложения

Подробное описание WEB API приложения изложено в раздле [Taskrest Api](./task_rest_api.md).
