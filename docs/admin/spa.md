# Одностраничные приложения

Интерфейс пользователя для доступа к БД и выполнения задач по формированию реестров,
выполнен в виде одностраничных приложений - <a href="https://developer.mozilla.org/en-US/docs/Glossary/SPA" target=_blank>SPA</a>.

Функционально работа с БД разбита на три части:

1. [Справочники](../user/sprav/sprav.md) - заполнение и корректировка справочников;
2. [Клиника](../user/clinic/clinic.md) - работа с картами и визитами пациентов;
3. [Реестры](../user/reestr/reestr.md) - формирование реестров.

Для каждого функционала написано свое собственное приложение _SPA_. Приложение
загружается в браузер пользователя в виде __javascript__ файла, который, в дальнейшем
исполняется средой браузера.

Для корректной работы _SPA_ подходит любой современный браузер, хотя, рекомендуется
бразузер на основе <a href="https://www.chromium.org" target=_blank>Chromium</a>.

_SPA_ приложения написаны с использованием _javascript_ фреймворка
<a href="https://mithril.js.org/" target=_blank>Mithril</a>. Выбор _Mithril_ вызван достаточно
простой архитектурой как самого фреймворка так и приложений, небольших по размеру и
с достаточно простой функциональностью.

## Данные передаваемые в _localStorage_

При загрузке приложения в браузер пользователя на локальный ПК дополнительно в
специальное хранилище <a href="https://developer.mozilla.org/ru/docs/Web/API/Window/localStorage" target=_blank>localStorage</a> передаются ряд параметров необходимых для корректной
работы приложения:

- `"apps":` перечень ссылок на доступные _SPA_;
- `"okato":` код ОКАТО для МО (для Демо МО "05000");
- `"pg_rest":` _URL_ [Postgrest](./pg_rest.md) сервера;
- `"task_rest":` _URL_ [Taskrest](./task_rest.md) сервера;
- `"token_url":` _URL_ по которому SPA будет запрашивать [JWT](./jwt_auth.md);
- `"this_mo":` имя аутентифицированного сайтом [omslite](http://omslite.site) пользователя

Передаваемые параметры есть только у __Демо МО__, и у [Зарегистрированных МО](../service/mo_register.md).

### Параметр _apps_

_APPS_ - _JSON_ объект представленный в строчном виде:

    {
        "clinic": {"href": "/apps/clinic/", "name": "Клиника"},
        "sprav": {"href": "/apps/sprav/", "name": "Справочники"},
        "reestr": {"href": "/apps/reestr/", "name": "Реестры"}
    }

В параметре перечислены все доступные для МО _SPA_ с их адресами на сайте и именами
в меню.

### Параметр _okato_

Просто код ОКАТО для данного МО, для _Демо МО_ выбран код __"05000"__.

### Параметры *pg_rest, task_rest*

Адреса серверов _Postgrest_ и _Taskrest_. По этим адресам _SPA_ обращаются чтобы
получить/отправить данные из/в БД или сформировать реестр. Эти адреса необходимо сообщить
при _Регистрации МО_. Если адреса этих серверов не известны, _SPA_ просто сообщают
об ошибке.

Для __Демо МО__:

    "pg_rest": "http://pgrest.omslite.site/"
    "task_rest": "http://taskrest.omslite.site"

### Параметр *token_url*

Адрес по которому _SPA_ запрашивают _JWT_. Если адрес не указан, то механизм
[Аутентификации по JWT](./jwt_auth.md) работать не будет.

### Параметр *this_mo*

Каждый зарегистрированный на сайте [omslite.site](http://omslite.site) пользователь связан
с одной из [Зарегистрированных МО](../service/mo_register.md). После аутентификации
пользователя сайт автоматически выполняет редирект на приложение
[Справочники](../user/sprav/sprav.md), и текущим будет МО, к которому привязан пользователь.
Сразу после регистрации пользователь привязан к __Демо МО__.

При регистрации МО, для него назначается учетная запись - Администратор. Для того,
чтобы привязать определенного пользователя к определенному зарегистрированному МО,
администратору этого МО нужно сделать заявку на электропочту сайта. Более подробная
информация изложена в разделе [Регистрация МО](../service/mo_register.md).

Если пользователь не связан ни с одним МО, то после аутентификации и попытки направить
в браузер пользователя приложение _Справочники_, возникает ошибка:

    404 Not Found.

Параметр **this_mo**, в контексте вышеизложенного, является просто именем пользователя,
который аутентифицирован и связан с одним из МО сайта.

## Cross-Origin Resource Sharing (CORS)

В документации уже [было упомянуто](./struct.md#браузер-пользователя), что запросы к
ресурсам [pg_rest](./pg_rest.md) и [task_rest](./task_rest.md) выполняются _SPA_ в среде
браузера пользователя на локальном ПК. Если
[протокол/адрес/порт/домен](#параметры-pgrest-taskrest) ресурса _Postgrest_ или _Taskrest
_ отличается от домена `omslite.site`, в этом случае браузер следуя политике
<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target=_blank>same-origin policy</a>, блокирует запросы к этим ресурсам.

Оба сервера и _Postgrest_ и _Taskrest_ справляются как с простыми, так и сложными запросами
и всегда возвращают заголовок:

    Access-Control-Allow-Origin: *

Однако, как правило северы _Postgrest_ или _Taskrest_ размещаются МО в __локальных
адресных пространствах__, не используя шифрования HTTPS, и следовательно браузер
будет блокировать любые запросы из публичного ресурса в локальную сеть.

Для того, чтобы разрешить доступ к ресурсам локальной сети, в браузере на основе _Chromium_
(версии >= 100) следует на странице

    chrome://flags/

флаг:

    Block insecure private network requests

установить в положение

    Disabled

> Разрешая доступ к локальным ресурсам, _системные администраторы МО_
> должны понимать, что защита в локальной сети от возможной компрометации
> в полной мере является сферой их ответственности.
