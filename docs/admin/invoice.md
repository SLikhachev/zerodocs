# Файл счета МИС ТФОМС

В актуальной версии приложения файл счета выгруженный из МИС ТФОМС, обрабатывается
непосредственно сервисом [task_rest](./task_rest.md). В дальнейщем планируется пренести
обработку протокола в библиотеку [barsxml](barsxml.md).

Для формирования _XLSX_ файла рееестра пролеченных, необходимо загрузить _ZIP_ файл
счета на сервер _Taskrest_. Файл загружается во временный каталог, и по окончании обработки
удаляется. В [рабочей БД](./workdb.md) для обработки создаются временный таблицы, которые
по окончании обработки удаляются.

Таким образом на сервере не остается информации о счете, поэтому, для повторного
формирования реестра, файл счета необходимо загружать заново.

## Имена файлов и содержание архива

Имя архива дожно удовлетворять следующему шаблону:

    <HD><mo_code><S><smo>_<year><month><lpu><nnn>.zip

Где:

- `<HD>` - 2 буквы, например: __HM__ (значения не имеют);
- `<mo_code>` - несколько цифр - [Код МО](../user/sprav/comm.md#мо-рф-по-f003)
- `<S>` - одна буква: __S или T__;
- `<smo>` - несколько цифр - [Код CМО](../user/sprav/comm.md#смо-рф-по-f002) или код региона;
- `<year>` - две последние цифры отчетного года, например: __22__;
- `<month>` - две цифры отчетного месяца, напрмер: __04__;
- `<lpu>` - три цифры: [короткий код МО](../user/sprav/local.md#мо-локальные);
- `<nnn>` - произвольная последовательность цифр.

Пример актуального имени архива:

    HM250999T25_22029991.zip
    HM250999S25011_211099910.zip

Если имя архива не удовлетворяет шаблону, обоаботка прерывается, и выдается сообщение
об ошибке.

Предполагается что в архиве должно быть как минимум 2 _XML_ файла:

1. начинающийся с букв `HM`;
2. начинающийся с букв `LM`.

Если таких файлов в архиве нет, обоаботка прерывается, и выдается сообщение об ошибке.

Предполагается что файлы `HM, LM` являются _XML_ файлами и имеют определенную
структуру. В актуальной версии приложения нет возможности гибкой настройки структуры
импотрируемого счета.

## Актуальная структура протокола

Анализ входного _XML_ файла производится последовательно, из входного потока выбираются
определенные стартовые узлы дерева записи, затем находятся определенные узлы дерева
записи и строится плоская выходная запись. Узлы не являющиеся стартовыми для записи и/или
не представляющие интереса для построения выходной записи игнорируются.

### Файл H

Стартовый узел: `ZAP`.

Ожидаемая структура записи:

    ZAP
        N_ZAP
        PACIENT
            ID_PAC
            SPOLIS
            NPOLIS
        Z_SL
            USL_OK
            VIDPOM
            FOR_POM
            DATE_Z_1
            DATE_Z_2
            RSLT
            ISHOD
            SL
                PROFIL
                NHISTORY
                DS1
                PRVS
            IDSP
            SUMV
            SUMP

### Файл L

Стартовый узел: `PERS`.

Ожидаемая структура записи:

    PERS
        ID_PAC
        FAM
        IM
        OT
        W
        DR

## XLSX шаблоны реестров

В актуальной версии приложения нет возможности для гибкого изменения шаблонов
выходных файлов XLSX реестов, не изменяя код приложения. В коде жестко определены
смещения ячеек таблиц. Возможность настройки шаблонов рассматривается в будущем.

Тех. персонал МО имеет возможность настроить шаблоны реестров самостоятельно.

Шаблоны для СМО и ТФОМС различаются, поэтому при формировании реестра, следует
выбирать тип выходного реестра:

- Амбулаторный - для СМО;
- Инокраевые - для ТФОМС;
- Тарифы ПМУ - для формирование реестра выполненных ПМУ.

Имена МО и СМО, отчетный месяц и год, в XLSX файлы вносятся исходя их анализа
имени архивного файла.

МО и СМО выбираются по их коду из таблиц [МО локальные](../user/sprav/local.md#мо-локальные),
[СМО локальные](../user/sprav/local.md#смо-локальные), соответственно. Если в этих справочниках
нет МО или СМО с нужным кодом, то в файл реестра будет выведена строка:

    'UNKNOWN MO NAME'
